# Скрипт для автоматической установки и настройки ASP.NET Core приложения с использованием Nginx и Kestrel


## Описание


Этот Bash-скрипт автоматизирует процесс развертывания ASP.NET Core приложения на сервере с использованием веб-сервера Nginx в качестве прокси и сервера приложений Kestrel для обработки запросов. Скрипт выполняет следующие шаги:


1. Устанавливает Nginx, если он не установлен.
2. Проверяет установленную версию .NET SDK и устанавливает необходимую, если она отсутствует.
3. Настраивает Nginx для проксирования запросов на порт приложения Kestrel.
4. Создаёт и настраивает службу systemd для запуска и управления приложением ASP.NET Core через Kestrel.


## Аргументы


Скрипт принимает следующие аргументы:


- `-p LISTEN_PORT PROXY_PORT`: задаёт порты для конфигурации Nginx. `LISTEN_PORT` — порт, на котором будет работать Nginx, а `PROXY_PORT` — порт приложения Kestrel.
- `-d APP_PATH`: полный путь к исполняемому файлу приложения (`.dll`).
- `-u USER`: (необязательный) пользователь, от имени которого будет запущено приложение Kestrel. Если аргумент не указан, используется владелец каталога с приложением.
- `-v ASPNETCORE_VERSION`: (необязательный) версия ASP.NET Core SDK для установки. Если не указана, используется версия по умолчанию (`7.0`).


## Пример использования


```bash
sudo deploy_service.sh -p 80 5000 -d /var/www/myapp/myapp.dll -u www-data -v 7.0
```


Этот пример:


- Настраивает Nginx для работы на порту `80` и проксирования запросов на порт `5000`, где будет работать Kestrel.
- Устанавливает и настраивает приложение, находящееся по пути `/var/www/myapp/myapp.dll`.
- Запускает приложение от имени пользователя `www-data`.
- Устанавливает версию .NET SDK `7.0`.


## Логика работы скрипта


### 1. Проверка и разбор аргументов


Скрипт сначала проверяет, что все обязательные аргументы (порты и путь к приложению) указаны, и выводит инструкцию по правильному использованию в случае их отсутствия.


### 2. Установка Nginx


Если Nginx не установлен, скрипт выполнит его установку через `apt-get`. Если Nginx уже установлен, это будет указано в выводе.


### 3. Установка .NET SDK


Скрипт проверяет, установлена ли указанная версия .NET SDK. Если она отсутствует, она будет установлена через `apt-get`.


### 4. Настройка Nginx


Создаётся конфигурационный файл Nginx для приложения, где:


- Настраивается прослушивание на указанном порту.
- Проксирование запросов на Kestrel, который работает на другом порту.


### 5. Настройка и запуск Kestrel


Скрипт создаёт службу systemd для управления ASP.NET Core приложением через Kestrel. Служба будет автоматически запускаться при старте системы и перезапускаться в случае сбоя.


### 6. Перезагрузка Nginx и проверка конфигурации


После настройки Nginx скрипт проверяет синтаксис конфигурации и перезагружает Nginx для применения изменений.


## Примечания


- Убедитесь, что у вас есть права суперпользователя (sudo), чтобы выполнить установку пакетов и настройку служб.
- Для корректной работы Nginx и Kestrel рекомендуется запускать скрипт от имени root или с использованием `sudo`.
